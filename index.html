<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Gamedev Canvas Workshop</title>
        <style>
            * { padding: 0; margin: 0 }
            canvas { background: #eee; display: block; margin: 0 auto; }
        </style>
    </head>
    <body>

        <canvas id="myCanvas" height="100px" width="100px"></canvas>

        <script>
          var rightPressed = false;
          var leftPressed = false;

          const canvas = document.getElementById("myCanvas");
          const ctx = canvas.getContext("2d");
          const characterSprites = new Image();
          const blockSprites = new Image();

          function gameLoop() {
            window.requestAnimationFrame(gameLoop);
            
            // Clear the screen
            ctx.beginPath();
            ctx.rect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "white";
            ctx.fill();
            ctx.closePath();

            mario.velX *= friction;
            mario.velY += gravity;

            boxes.forEach(box => {
              ctx.drawImage(
                box.image,
                box.spriteX,
                box.spriteY,
                box.width,
                box.height,
                box.x,
                box.y,
                box.width,
                box.height
              );
              var dir = collisionDetection(mario, box);

              if (dir === "l" || dir === "r") {
                mario.velX = 0;
                mario.jumping = false;
              } else if (dir === "b") {
                mario.grounded = true;
                mario.jumping = false;
              } else if (dir === "t") {
                mario.velY *= -1;
              }
            });

            if(mario.grounded){
                mario.velY = 0;
            }
            
            mario.x += mario.velX;
            mario.y += mario.velY;

            mario.update();
            mario.render();
          }

          const keyDownHandler = (e) => {
            switch (e.keyCode) {
              case 39:
                rightPressed = true;
                break;
              case 37:
                leftPressed = true;
                break;
              case 38:
                mario.jump();
              default:
            }
          }

          const keyUpHandler = (e) => {
            switch (e.keyCode) {
              case 39:
                rightPressed = false;
                break;
              case 37:
                leftPressed = false;
                break;
              default:
            }
          }
          const friction = 0.8;
          const gravity = 0.3;

          function collisionDetection(shapeA, shapeB) {
            // get the vectors to check against
            var vX = (shapeA.x + (shapeA.width / 2)) - (shapeB.x + (shapeB.width / 2)),
                vY = (shapeA.y + (shapeA.height / 2)) - (shapeB.y + (shapeB.height / 2)),
                // add the half widths and half heights of the objects
                hWidths = (shapeA.width / 2) + (shapeB.width / 2),
                hHeights = (shapeA.height / 2) + (shapeB.height / 2),
                colDir = null;

            // if the x and y vector are less than the half width or half height, they we must be inside the object, causing a collision
            if (Math.abs(vX) < hWidths && Math.abs(vY) < hHeights) {
              // figures out on which side we are colliding (top, bottom, left, or right)
              var oX = hWidths - Math.abs(vX),
                  oY = hHeights - Math.abs(vY);
              if (oX >= oY) {
                if (vY > 0) {
                  colDir = "t";
                  shapeA.y += oY;
                } else {
                  colDir = "b";
                  shapeA.y -= oY;
                }
              } else {
                if (vX > 0) {
                  colDir = "l";
                  shapeA.x += oX;
                } else {
                  colDir = "r";
                  shapeA.x -= oX;
                }
              }
            }
            return colDir;
        }
          const sprite = {
            init(options) {
              this.context = options.context;
              this.width = options.width;
              this.height = options.height;
              this.image = options.image;
              this.jumping = false;
              this.grounded = false;
              this.speed = 3;
              this.velX = 0;
              this.velY = 0;

              // Sprite logic
              this.frameIndex = 0;
              this.tickCount = 0;
              this.ticksPerFrame = options.ticksPerFrame || 0;
              this.numberOfFrames = options.numberOfFrames || 1;
              this.spriteStartX = options.spriteStartX;
              this.spriteStartY = options.spriteStartY;
              this.spriteSeparator = options.spriteSeparator;
              this.spriteSeparator = options.spriteSeparator;
              this.faceRight = true;
              
              // Canvas position
              this.x = 0;
              this.y = 0;
            },
            moveForward() {
              if (this.x + 2 < canvas.width - this.width) { // Don't go off the map
                if (this.velX < this.speed) {
                  this.velX++;
                }
              }
            },
            moveBackward() {
              if (this.x - 2 > 0) { // Don't go off the map
                if (this.velX > -this.speed) {
                  this.velX--;
                }
              }
            },
            jump() {
              if (!this.jumping && this.grounded) {
                this.jumping = true;
                this.grounded = false;
                this.velY -= this.speed * 2;
              }
            },
            render() {

              // Draw the animation
              this.context.drawImage(
                this.image,
                this.spriteStartX + (this.frameIndex * (this.width + this.spriteSeparator)),
                this.spriteStartY,
                this.width,
                this.height,
                this.x,
                this.y,
                this.width,
                this.height
              );

            },
            update() {
              this.tickCount += 1;

              if (this.tickCount > this.ticksPerFrame) {
                this.tickCount = 0;

                if (rightPressed || leftPressed) {

                  if (rightPressed) {
                    this.spriteStartY = 0;
                    this.moveForward();
                  } else {
                    this.spriteStartY = 17;
                    this.moveBackward();
                  }

                  this.velX *= friction;
                  this.velY += gravity;

                  // Check to see if the current frame index is in range
                  if (this.frameIndex < this.numberOfFrames - 1) {
                    // Go to the next frame
                    this.frameIndex += 1;
                  } else {
                    this.frameIndex = 0;
                  }

                  if (this.jumping) {
                    this.frameIndex = 5;
                  }
                }
              }
            },
          };

          
          const box = {
            width: 16,
            height: 16,
            spriteX: 272,
            spriteY: 112,
            image: blockSprites,
            init(x, y = canvas.height - 16) {
              this.x = x;
              this.y = y;
            }
          }

          const boxes = [];

          for (let i = 0; i * box.width < canvas.width; i += 1) {
            const newBox = Object.create(box);
            newBox.init(i * box.width);
            boxes.push(newBox);
          }

          const mario = Object.create(sprite);

          mario.init({
            context: ctx,
            width: 16,
            height: 16,
            image: characterSprites,
            numberOfFrames: 4,
            ticksPerFrame: 4,
            spriteStartX: 1,
            spriteStartY: 0,
            spriteSeparator: 1,
            jumpHeight: 45,
          });

          // Start the game loop as soon as the sprite sheet is loaded
          characterSprites.addEventListener("load", gameLoop);
          document.addEventListener('keydown', keyDownHandler);
          document.addEventListener('keyup', keyUpHandler);
          characterSprites.src = "sprites/mario.gif";
          blockSprites.src = "sprites/blocks.png";
        </script>
    </body>
</html>