<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Gamedev Canvas Workshop</title>
        <style>
            * { padding: 0; margin: 0 }
            canvas { background: #eee; display: block; margin: 0 auto; }
        </style>
    </head>
    <body>

        <canvas id="myCanvas" height="100px" width="100px"></canvas>

        <script>
          var rightPressed = false;
          var leftPressed = false;

          const canvas = document.getElementById("myCanvas");
          const ctx = canvas.getContext("2d");
          const characterSprites = new Image();

          function gameLoop() {
            window.requestAnimationFrame(gameLoop);
            
            // Clear the screen
            ctx.beginPath();
            ctx.rect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "white";
            ctx.fill();
            ctx.closePath();

            mario.update();
            mario.render();
          }

          const keyDownHandler = (e) => {
            switch (e.keyCode) {
              case 39:
                rightPressed = true;
                break;
              case 37:
                leftPressed = true;
                break;
              case 38:
                mario.jump();
              default:
            }
          }

          const keyUpHandler = (e) => {
            switch (e.keyCode) {
              case 39:
                rightPressed = false;
                break;
              case 37:
                leftPressed = false;
                break;
              default:
            }
          }

          const sprite = {
            init(options) {
              this.frameIndex = 0;
              this.tickCount = 0;
              this.ticksPerFrame = options.ticksPerFrame || 0;
              this.numberOfFrames = options.numberOfFrames || 1;

              this.context = options.context;
              this.width = options.width;
              this.height = options.height;
              this.image = options.image;
              this.spriteStartX = options.spriteStartX;
              this.spriteStartY = options.spriteStartY;
              this.spriteSeparator = options.spriteSeparator;
              this.x = 0;
              this.y = canvas.height - this.height;
              this.faceRight = true;
              this.jumping = false;
              this.reachedTopOfJump = false;
              this.jumpHeight = canvas.height - this.height - options.jumpHeight;
            },
            moveForward() {
              if (this.x + 2 < canvas.width - this.width) {
                this.x += 2;
              }
            },
            moveBackward() {
              if (this.x - 2 > 0) {
                this.x -= 2;
              }
            },
            jump() {
              if (!mario.jumping) {
                mario.reachedTopOfJump = false;
                mario.jumping = true;
              }
            },
            render() {

              // Draw the animation
              this.context.drawImage(
                this.image,
                this.spriteStartX + (this.frameIndex * (this.width + this.spriteSeparator)),
                this.spriteStartY,
                this.width,
                this.height,
                this.x,
                this.y,
                this.width,
                this.height
              );

            },
            update() {
              this.tickCount += 1;

              if (this.tickCount > this.ticksPerFrame) {
                this.tickCount = 0;

                if (this.jumping) {
                  if (this.y > this.jumpHeight && !this.reachedTopOfJump) {
                    this.y -= 2;
                  } else {
                    this.reachedTopOfJump = true;
                    if (this.y < canvas.height - this.height) {
                      this.y += 2;
                    } else {
                      this.reachedTopOfJump = false;
                      this.jumping = false;
                    }
                  }
                }

                if (rightPressed || leftPressed) {

                  if (rightPressed) {
                    this.spriteStartY = 0;
                    this.moveForward();
                  } else {
                    this.spriteStartY = 17;
                    this.moveBackward();
                  }

                  // Check to see if the current frame index is in range
                  if (this.frameIndex < this.numberOfFrames - 1) {
                    // Go to the next frame
                    this.frameIndex += 1;
                  } else {
                    this.frameIndex = 0;
                  }

                  if (this.jumping) {
                    this.frameIndex = 5;
                  }
                }
              }
            },
          };


          const mario = Object.create(sprite);

          mario.init({
            context: ctx,
            width: 16,
            height: 16,
            image: characterSprites,
            numberOfFrames: 4,
            ticksPerFrame: 4,
            spriteStartX: 1,
            spriteStartY: 0,
            spriteSeparator: 1,
            jumpHeight: 45,
          });

          // Start the game loop as soon as the sprite sheet is loaded
          characterSprites.addEventListener("load", gameLoop);
          document.addEventListener('keydown', keyDownHandler);
          document.addEventListener('keyup', keyUpHandler);
          characterSprites.src = "sprites/mario.gif";
        </script>
    </body>
</html>